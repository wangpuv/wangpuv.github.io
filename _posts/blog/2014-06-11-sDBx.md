---
layout:         post
title:          sDBx XML生成框架设计说明
category:       blog
description:    当同事把以前开发的xml上报的程序发给我的时候，我发现这些代码看起来有点头疼，真的有些凌乱，我是不是该重写一个呢？
---

## 来自过去的文档

其实这是我2013年编写的，由于种种原因，这个我闲暇时写的框架并没有派上用场，所以我决定把当时总结的文档拿出来，编辑成 Blog，分享给大家。

然后也把源码修改了一下开源出来，希望能为它找到用武之地。

[https://github.com/wangpuv/sDBx][]

## 为什么会有这个框架？

首先说一下框架的名字sDBx，它的意思是“帅的不行”的缩写，当然也是 schema and DB to XML by jaxb2 的缩写。玩笑开完，我们说正题，为什么会有这个框架呢？

当同事把以前开发的 xml 上报的程序发给我了解的时候，我发现，这些代码看起来有点头疼，真的有些凌乱。这些代码的主要目的是根据指定的 XML schema文档（.xsd）把数据库中的数据生成 XML，并上传。为了实现这个目标，该程序为每一个生成 XML 的任务都单独写了一组代码（包括验证 XML 的代码，虽然是同一个 java 类，但也是分成单独的方法在处理），这些代码有太多重复或相似的部分，而且大段代码集中一起，纷繁错杂。之前，我刚好读过 Martin Fowler 的《重构》，也许这些代码应该有一个新生命了。

对于我这个目前还不太清楚具体业务细节的新手来说，重新做一个框架也许是最简单有效的选择，那就开始吧。

## 这个框架该怎么做？

Martin Fowler 告诉我，在你没有弄清楚代码的目的之前，千万不要动手修改，所以我先从其中一个 XML 生成任务入手，了解这些代码的来龙去脉。我阅读了其中的一个类，我把它的工作流程梳理如下：

* 读取 生成文件临时目录路径 等配置文件；
* 获取数据库连接；
* 获取XML的创建时间；
* 获取XML统计起始时间；
* 获取XML统计截止时间；
* 定义上传文件名称；
* 检查是否有传入参数；
* 生成XML头部分；
* 创建目录和文件（如果文件已存在就删除重建）；
* 设置流及编码；
* 通过数据库获取操作记录并组装XML；
* 获取主帐号对应的角色信息；
* 获取主帐号对应的组织机构的全路径；
* 拼装XML结束部分；
* 上传到本地待上传目录；
* 删除临时文件；
* 将本次生成上传的日志插入数据库。

代码的流程大概可以分为这样几个部分：获取数据库连接及查询，文件及目录的创建、复制及删除操作，XML 拼装。

这个类的主要问题是，整个代码都是揉合在一个类里面，整体没有经过设计，显得杂乱无章；应该使用工具类，或者单独封装的地方，没有使用，比如：文件操作；代码基本没有复用的可能，灵活性比较差，一旦需求变动，很多地方都需要改动。这是面向过程而不是面向对象的代码。

《重构》告诉我，每一个类都应当承担自己应有的职责，如果一个类的职责太多，就应当重构。显着，这个类承担了太多的职责，它应当有同伴来分担。

同时，我也注意到其它的类，它们承担着其它 XML 生成的任务，但是结构相差无几，特别是XML拼装的工作，显得重复和繁琐。

那我就从 XML 拼装入手吧！

怎么样才能让 XML 自己拼装起来，并且符合 xsd 的描述呢？我想到了很久以前用过的一个工具 jaxb2，它能够将 xsd 映射为 java 对象，并从而实现 java 对象到 XML 的双向转换。

好，这个问题解决了，但是我还是要一个一个写代码，手动创建对象，查询数据库，再生成 XML，能不能让它们自动完成这些工作呢？我想到了 java 的反射机制，通过反射来创建 java 对象，查询数据库，给对象赋值，来生成 XML。

那反射创建的依据是什么呢？XML 配置文件！这是最简单的方式了，而且被普遍采用。我可以把数据库处理结果和 java 对象值域的关系，通过 XML 配置文件描述出来，由某个程序通过解析这个关系，然后按照既定的操作去反射创建 java 对象，查询数据库，根据查询结果给 java 对象赋值，然后调用 jaxb2 根据 java 对象生成 XML。这个程序就是我要做的框架—— sDBx！

## 框架设计

sDBx 框架的目标是，通过 xsd 和配置文件生成 xml，为了达到以后有新需求要生成新的 xml，只需要增加一个配置文件即可的效果，这个框架必须考虑更多的通用性，包括一些特殊情况的处理，等等。但是，我的时间和精力是有限的，所以第一版暂定实现功能如下：

* 通过jaxb2将xsd生成java类；
* 数据库查询结果与要生成的xml关系描述XML配置文件的解析；
* 根据上述配置文件反射创建java对象并执行数据库操作给对象赋值；
* 通过jaxb2将java对象序列化为xml文件；
* 处理特殊xml字段的取值问题。

根据以上功能，框架大概分为：xsd 生成，数据库连接管理，配置文件解析，xml 文件生成，这四个模块。

xsd 生成模块主要负责通过 jaxb2 将 xsd 生成 java 类，因为 JDK6 以后就将 jaxb2 包含进去了，所以只要安装了 JDK6 就能用命令来生成 java 类。不过，为了跟国际接轨，使这个框架更洋气一些，我采用了 Maven 这个构建工具来管理这些生成，当然我也编写了批处理命令方便 Windows 环境下的开发者使用。总体来说，这部分基本上不需要编写 java 代码。

数据库连接管理模块主要负责管理数据库连接，可以通过多种方式获取，满足开发和测试的需要。另外，由于数据库操作包括了插入记录，所以也需要事物管理。

配置文件解析模块，这是整个框架的核心模块，首先我要定义出配置文件的格式，然后读取配置文件并将它放入缓存中待用，这需要一个配置文件的解析类和管理类。最好的办法是把配置文件映射为 java 对象来管理。

xml 文件生成模块主要负责执行配置文件中的描述方法，将正确的值赋予 java 对象，当然，它要首先通过反射生成这些 java 对象，最后通过 jaxb2 工具将这些对象序列化为 xml 文件。

同时，对于 xml 特殊字段的取值，参考 JDK 中 xml 验证的处理方式，给出 Handler 处理接口，给框架使用者根据实际情况自己来编写处理。

整个框架生成xml的流程如下：

*  将 xsd 生成 java 类放入指定的包路径中；
*  解析配置文件，生成配置文件对象，存放在缓存中使用；
*  生成 xml 任务开始时，根据要生成的 xml 类型，从缓存中获取对应的配置文件对象；
*  根据配置对象，反射生成要生成的 xml 对应 java 对象；
*  根据配置对象，获取目标数据库连接，并执行操作获取结果集，将正确的值赋予 java 对象；
*  特殊的 xml 字段进行特殊接口处理，获取正确的值。
*  通过 jaxb2 工具将 java 对象序列化为 xml 文件。

xml 文件生成过程由 jaxb2 负责，日期都是 xml 标准，我不需要再进行特别处理，很方便。

## sDBx框架的优点

整个框架层次清晰分明，xml 生成实现自动化。

框架使用者根据每个 xml 生成任务，只要编写一个配置文件，如果有特别的处理，只需要另外实现 Handler 处理接口，（如果多个处理一样，实现 Handler 内容部分是可以复用的），并在配置中配好即可，大大简化了开发过程，使代码更易于阅读、管理。

框架采用 Maven 构建管理，每个模块都对应的有单元测试，覆盖率达到90%以上，针对变化能够快速测试。

## 其它思考

为什么我们的代码会缺少设计？

我想大概多数情况下，开发者接到开发需求的时候，时间都比较紧张，“现在就动手干吧，否则就来不及了！”这可能是第一反应。设计实现需要很多探索的经验，我在使用 jaxb2 的时候也有很多疑问，这需要时间来探索，而且有可能失败，需要重头再来。

优秀的开发设计需要思考，需要创造，需要雕琢，需要时间。

同时，优秀的代码需要生命，它的生命来自于分享和开源。即使公司内部的产品也可以在内部共享交流。一成不变的代码是没有生命力的，只有让更多的人去阅读它，去修改它，去改善它，它才能更有生命力。

[https://github.com/wangpuv/sDBx]:       https://github.com/wangpuv/sDBx                                    "https://github.com/wangpuv/sDBx"